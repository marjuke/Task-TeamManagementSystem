# System Architecture Overview

## ??? High-Level Architecture

```
???????????????????????????????????????????????????????????????????
?                        Client Application                        ?
?                      (Web/Mobile/Desktop)                       ?
???????????????????????????????????????????????????????????????????
                           ?
                    JWT Token (Bearer)
                           ?
                           ?
???????????????????????????????????????????????????????????????????
?                     ASP.NET Core API                             ?
?                      (Authorization)                             ?
??????????????????????????????????????????????????????????????????
           ?                              ?
    ??????????????????          ???????????????????
    ?  Controllers   ?          ?   Controllers   ?
    ?  - Teams       ?          ?  - WorkTasks    ?
    ?  - Account     ?          ?  - Account      ?
    ??????????????????          ???????????????????
           ?                              ?
    ??????????????????????????????????????????????
    ?         MediatR Request Pipeline           ?
    ?  (CQRS - Command/Query Separation)         ?
    ??????????????????????????????????????????????
           ?                              ?
    ???????????????????          ??????????????????
    ?    Commands     ?          ?     Queries    ?
    ?  - Create       ?          ?  - GetAll      ?
    ?  - Update       ?          ?  - GetById     ?
    ?  - Delete       ?          ?  - GetByTeam   ?
    ???????????????????          ??????????????????
           ?                              ?
    ??????????????????????????????????????????????
    ?         Entity Framework Core              ?
    ?        (ORM - Data Access Layer)          ?
    ??????????????????????????????????????????????
           ?                              ?
    ??????????????????????????????????????????????
    ?          SQL Server Database               ?
    ?  ??????????  ??????????  ??????????       ?
    ?  ? Teams  ?  ? Tasks  ?  ?Status  ?       ?
    ?  ??????????  ??????????  ??????????       ?
    ?  ??????????????????????????????            ?
    ?  ?  AspNetUsers (Identity)    ?            ?
    ?  ??????????????????????????????            ?
    ???????????????????????????????????????????????
```

---

## ?? Request Flow Diagram

### For Team Creation (Admin Only)

```
                    Client
                       ?
                       ? POST /api/teams
                       ? {name, description}
                       ?
          ??????????????????????????
          ?  TeamsController       ?
          ?  CreateTeam()          ?
          ??????????????????????????
                   ?
                   ? Mediator.Send(CreateTeamCommand)
                   ?
          ??????????????????????????
          ?  Authorize             ?
          ?  Policy: Admin         ?
          ??????????????????????????
                   ? ? Authorized
                   ?
          ??????????????????????????????????????
          ?  CreateTeamCommandHandler          ?
          ?  Handle(command)                   ?
          ??????????????????????????????????????
                   ?
                   ? Create Team Entity
                   ?
          ??????????????????????????????????????
          ?  DbContext.SaveAsync()             ?
          ?  (SQL INSERT)                      ?
          ??????????????????????????????????????
                   ?
                   ? Team Created
                   ?
          ??????????????????????????????????????
          ?  Return TeamDTO                    ?
          ?  {id, name, description, tasks}    ?
          ??????????????????????????????????????
                   ?
                   ? HTTP 201 Created
                   ?
                  Client
```

### For Task Creation (Manager/Admin Only)

```
                    Client
                       ?
                       ? POST /api/worktasks
                       ? {title, description, ...}
                       ?
          ??????????????????????????
          ?  WorkTasksController   ?
          ?  CreateTask()          ?
          ??????????????????????????
                   ?
                   ? Mediator.Send(CreateWorkTaskCommand)
                   ?
          ??????????????????????????
          ?  Authorize             ?
          ?  Policy: ManagerOrAdmin?
          ??????????????????????????
                   ? ? Authorized
                   ?
          ???????????????????????????????????????
          ?  CreateWorkTaskCommandHandler       ?
          ?  Handle(command)                    ?
          ?????????????????????????????????????
                   ?
                   ? Get Current User
                   ? from HttpContext
                   ?
          ???????????????????????????????????????
          ?  Create WorkTask Entity             ?
          ?  Set CreatedByUserId (Current User) ?
          ?  Set AssignedToUserId (Param)       ?
          ?????????????????????????????????????
                   ?
                   ? Validate References
                   ? (Team, Status, AssignedUser)
                   ?
          ???????????????????????????????????????
          ?  DbContext.SaveAsync()              ?
          ?  (SQL INSERT)                       ?
          ?????????????????????????????????????
                   ?
                   ? Load Related Data
                   ? Include(Status, Team, Users)
                   ?
          ???????????????????????????????????????
          ?  Return WorkTaskDTO                 ?
          ?  (Enriched with related info)       ?
          ?????????????????????????????????????
                   ?
                   ? HTTP 201 Created
                   ?
                  Client
```

---

## ?? Entity Relationship Diagram

```
???????????????????????
?      Teams          ?
???????????????????????
? PK ? Id              ?
?    ? Name            ?
?    ? Description     ?
???????????????????????
     ? 1:N
     ?
     ?
     ?
????????????????????????????
?      WorkTasks           ?
????????????????????????????
? PK ? Id                  ?
? FK ? TeamId              ? ??????????????????????
? FK ? StatusId            ?       ?              ?
? FK ? AssignedToUserId    ?   ???????????? ?????????????
? FK ? CreatedByUserId     ?   ? Statuses ? ?AspNetUsers?
?    ? Title               ?   ???????????? ?????????????
?    ? Description         ?   ? Id       ? ? Id        ?
?    ? DueDate             ?   ? Name     ? ? Email     ?
????????????????????????????   ? (Todo)   ? ? UserName  ?
                               ? (In Prog)? ? DisplayNm ?
                               ? (Done)   ? ? Roles     ?
                               ???????????? ?????????????
```

---

## ?? Authorization Layer

```
Request comes in with JWT Token
            ?
            ?
    ?????????????????????
    ? Authenticate User ?
    ? (JWT Validation)  ?
    ?????????????????????
             ? ? Valid
             ?
    ?????????????????????????????????
    ? Extract User & Roles from JWT ?
    ?????????????????????????????????
             ?
             ?
    ??????????????????????????????
    ? Match against Policy       ?
    ? AdminOnly                  ?
    ? AdminCanManageTeams        ?
    ? ManagerOrAdmin             ?
    ? EmployeeOrAbove            ?
    ??????????????????????????????
             ?
        ???????????
        ?          ?
    ?Allow    ?Deny
        ?          ?
        ?          ?
    Continue   403 Forbidden
    Request
```

---

## ?? CQRS Pattern Flow

### Query (Read) Path

```
Client Request (GET)
        ?
        ?
   Controller
        ?
        ?
   Create Query Object
        ?
        ?
   Mediator.Send(Query)
        ?
        ?
   QueryHandler
        ?
        ??? DbContext.QueryAsync()
        ?        ?
        ?        ?
        ?   Include Related Entities
        ?        ?
        ?        ?
        ?   Map to DTO
        ?
        ??? Return DTO
               ?
               ?
          Controller Returns DTO
               ?
               ?
          Client Response (200 OK)
```

### Command (Write) Path

```
Client Request (POST/PUT/DELETE)
        ?
        ?
   Controller
        ?
        ?
   Authorize (Check Roles)
        ? ? Authorized
        ?
   Create Command Object
        ?
        ?
   Mediator.Send(Command)
        ?
        ?
   CommandHandler
        ?
        ??? Get Current User
        ?
        ??? Create/Update/Delete Entity
        ?        ?
        ?        ?
        ?   DbContext.SaveAsync()
        ?        ?
        ?        ?
        ?   SQL Execute (INSERT/UPDATE/DELETE)
        ?        ?
        ?        ?
        ?   Reload Related Data
        ?        ?
        ?        ?
        ?   Map to DTO
        ?
        ??? Return DTO
               ?
               ?
          Controller Returns DTO
               ?
               ?
   Client Response (201/200 Created)
```

---

## ?? Folder Structure & Separation of Concerns

```
Api/
??? Controllers/          ? HTTP Request Handling
?   ??? TeamsController.cs       (Endpoint definitions)
?   ??? WorkTasksController.cs   (Endpoint definitions)
?   ??? BaseApiController.cs     (Mediator injection)
?
??? Features/             ? Business Logic (CQRS)
?   ??? Teams/
?   ?   ??? Queries/     (Read operations)
?   ?   ?   ??? GetAllTeamsQuery.cs
?   ?   ?   ??? GetAllTeamsQueryHandler.cs
?   ?   ?   ??? GetTeamByIdQuery.cs
?   ?   ?   ??? GetTeamByIdQueryHandler.cs
?   ?   ??? Commands/    (Write operations)
?   ?       ??? CreateTeamCommand.cs
?   ?       ??? CreateTeamCommandHandler.cs
?   ?       ??? UpdateTeamCommand.cs
?   ?       ??? UpdateTeamCommandHandler.cs
?   ?       ??? DeleteTeamCommand.cs
?   ?       ??? DeleteTeamCommandHandler.cs
?   ??? WorkTasks/
?       ??? Queries/
?       ?   ??? GetAllTasksQuery.cs
?       ?   ??? GetAllTasksQueryHandler.cs
?       ?   ??? GetTaskByIdQuery.cs
?       ?   ??? GetTaskByIdQueryHandler.cs
?       ?   ??? GetTasksByTeamQuery.cs
?       ?   ??? GetTasksByTeamQueryHandler.cs
?       ??? Commands/
?           ??? CreateWorkTaskCommand.cs
?           ??? CreateWorkTaskCommandHandler.cs
?           ??? UpdateWorkTaskCommand.cs
?           ??? UpdateWorkTaskCommandHandler.cs
?           ??? DeleteWorkTaskCommand.cs
?           ??? DeleteWorkTaskCommandHandler.cs
?
??? DTOs/                 ? Data Transfer Objects
?   ??? TeamDTO.cs
?   ??? CreateTeamDTO.cs
?   ??? UpdateTeamDTO.cs
?   ??? WorkTaskDTO.cs
?   ??? CreateWorkTaskDTO.cs
?   ??? UpdateWorkTaskDTO.cs
?
??? Services/
    ??? TokenService.cs   (JWT Generation)
    ??? ITokenService.cs  (Interface)

Domain/
??? Team.cs              ? Domain Models
??? WorkTask.cs
??? Status.cs
??? User.cs

Persistence/
??? AppDBContext.cs      ? EF Core DbContext
??? DbInitializer.cs     ? Seed Data
??? Migrations/

```

---

## ?? Dependency Injection Chain

```
Program.cs
    ?
    ??? AddHttpContextAccessor()
    ?       ??? IHttpContextAccessor (for getting current user)
    ?
    ??? AddMediatR()
    ?       ??? IMediator
    ?       ??? Query Handlers
    ?       ??? Command Handlers
    ?
    ??? AddScoped<ITokenService, TokenService>()
    ?       ??? ITokenService (JWT generation)
    ?
    ??? AddIdentityCore<User>()
    ?       ??? UserManager<User>
    ?       ??? RoleManager<IdentityRole>
    ?       ??? SignInManager<User>
    ?
    ??? AddAuthentication(JwtBearerDefaults)
    ?       ??? JWT Bearer scheme
    ?
    ??? AddAuthorizationBuilder()
    ?       ??? AdminOnly policy
    ?       ??? AdminCanManageTeams policy
    ?       ??? ManagerOrAdmin policy
    ?       ??? EmployeeOrAbove policy
    ?
    ??? AddDbContext<AppDBContext>()
            ??? DbContext (SQL Server)
```

---

## ?? Data Flow Example: Create Task

```
1. Client sends POST /api/worktasks
   ?? JWT Token in header
   ?? JSON body with task details

2. Authentication Middleware
   ?? Validates JWT
   ?? Extracts user info & roles

3. Authorization Middleware
   ?? Checks if user has ManagerOrAdmin role
   ?? ? Authorized ? Continue

4. WorkTasksController.CreateTask()
   ?? Maps request to CreateWorkTaskDTO
   ?? Creates CreateWorkTaskCommand

5. MediatR Pipeline
   ?? Routes to CreateWorkTaskCommandHandler
   ?? Handler processes command

6. CreateWorkTaskCommandHandler.Handle()
   ?? Gets current user from HttpContext
   ?? Creates WorkTask entity
   ?? Sets CreatedByUserId = currentUser.Id
   ?? Sets AssignedToUserId = request.AssignedToUserID
   ?? Calls dbContext.WorkTasks.Add()

7. DbContext.SaveAsync()
   ?? EF Core tracks changes
   ?? Generates SQL INSERT
   ?? Executes against database

8. Load Related Data
   ?? Include(Status)
   ?? Include(Team)
   ?? Include(AssignedToUser)
   ?? Include(CreatedByUser)

9. Map to WorkTaskDTO
   ?? Copy entity properties
   ?? Add related entity names
   ?? Return enriched DTO

10. Controller returns CreatedAtAction()
    ?? HTTP 201 Created
    ?? Location header with new resource URL
    ?? Response body with created resource

11. Client receives response
    ?? Status: 201 Created
    ?? Body: Complete WorkTaskDTO
```

---

## ? Key Design Patterns

### 1. **CQRS (Command Query Responsibility Segregation)**
- Separates read (Queries) from write (Commands)
- Improves scalability and maintainability
- Clear separation of concerns

### 2. **Mediator Pattern**
- MediatR acts as central hub
- Decouples controllers from handlers
- Supports cross-cutting concerns

### 3. **Repository-like Pattern**
- EF Core acts as repository
- Handler directly uses DbContext
- Clean data access

### 4. **DTO Pattern**
- Separates domain models from API contracts
- Prevents exposing internal structure
- Enables response enrichment

### 5. **Authorization Policy Pattern**
- Centralized policy definitions
- Reusable across endpoints
- Easy to modify permissions

---

**Architecture designed for scalability, maintainability, and security! ??**
